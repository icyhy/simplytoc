---
layout:     post
title:      "gitwriter项目6"
subtitle:   " \"图片保存在哪里的问题\""
date:       2017-12-21 23:35:00
author:     "huangyang"
header-img: "img/post-bg-2015.jpg"
tags:
    - gitwriter
---
# 当前目标   
- 主题编辑页面（markdown编辑）
# 设计思路
进展到markdown编辑功能的时候，碰到了一个很严峻的问题。就是markdown文件中的图片存在哪里的问题？  
![输入图片说明]({{ site.baseurl }}/img/in-post/2017-12-21-gitwriter6-234024_1c413787_58701.png "1.png")   
在gitee网站上编辑markdown文件时，点击图片按键，弹出图片上传对话框，如上图，选择图片后，图片被上传到gitee的uploads目录下，其实是一个公共目录，和本项目没啥关系，生成上述`https://gitee.com/uploads/images/2017/1222/234024_1c413787_58701.png`外链，访问这个外链是不需要gitee授权的（所以才叫外链嘛）。问题在于gitee开放的openapi中，没有图片上传的api（可以理解嘛，人家本来也不想提供一个公开的免费的图片仓库）。只有在使用码云的pages服务，并且在码云的在线markdown编辑页面中，才能够使用它的图片上传。  
 
说的有点绕了，简言之，就是第三方app没法使用码云的图片上传功能，拿到授权也不行。怎么办呢？首先想到的几种思路如下：
- 使用专门的图片外链网站
- 自己的服务端实现图片上传（上传到自己的服务器上或进而上传到阿里云oss上）  

下面分析一下这两种思路，第一种肯定是能够工作的，但不是我要的。外链图片网站的服务是否稳定且不说，把图片放到git以外的地方本身就是不能接受的。这个应用叫做gitwriter，目标之一就是把最终数据完完整整的放在用户自己的git仓库里面，应用提供了一个手段，或者提供了git使用的另外一个视角罢了。有一天，用户不想使用gitwriter时，会发现，自己原来的数据还是自己的，自己拥有完整的控制权，一句话、一个字、一张图片都没有丢失。所以，图片应该想办法放到用户自己的pages项目仓库中。第二种思路更不可取，原因和第一条思路的问题一样，并且我也没钱去申请更多的服务器资源（本身提供的就是一种免费服务，是一种借鸡生蛋的服务）。一旦图片放到应用服务器上，随之而来的就是静态文件的数据读写瓶颈（得申请oss解决，申请更高的服务器网络带宽等等），一大笔money啊。我要自己做这些，干啥还利用gitee呢？   

剩下的路就只剩下一条了，就看怎么去走通了。就是要把图片存放在git仓库里面。然后想办法去调用它。过程不多说了。直接说最后的设计思路把。图片上传后，通过文件操作上传到pages项目仓库的某一个固定路径下，例如“img”目录，然后在markdown文件中生成的链接格式如`\img\xxxxxxx.jpg`，这样最终jekyll最终生成site时候，会把这个路径下的文件复制到最终网页的静态文件路径下，页面渲染的时候，类似于通过相对路径来访问图片时可行的。   

但这样带来一个新的问题，就是编辑过程中的预览（不是pages服务最终得到的静态网站），使用marked控件渲染markdown文件得到的html输出，里面的图片使用相对路径是无法拿到图片的。解决办法有点麻烦，编辑预览一定是用户在通过授权之后进行的操作。因此可以通过文件名称及路径使用git文件操作api最终拿到这个文件。经测试，可以拿到图片文件的base64格式的数据。在应用中预览的时候，可以将图片的http链接替换成图片对应的base64数据，格式如   
```
data:image/gif;base64,R0lGODlhHAAmAKIHAKqqqsvLy0hISObm5vf394uLiwAAAP///yH5B…EoqQqJKAIBaQOVKHAXr3t7txgBjboSvB8EpLoFZywOAo3LFE5lYs/QW9LT1TRk1V7S2xYJADs=
```
相当于把图片数据直接签入到生成的html页面中，一次加载了。目前的思路如此，具体实现时，还有两点需要解决：   
- 应用预览时使用的marked控件是否支持base64图片路径，如果支持，可能需要在marked转换后，遍历生成的html标签来进行替换。
- 图片比较大的时候，生成的数据很长，超过了java String类型的上限，处理起来会有问题。（是限制用户图片的大小还是怎么办？）   

# 进展
截至目前，就得到这么多。   
![输入图片说明]({{ site.baseurl }}/img/in-post/2017-12-21-gitwriter6-003014_88ce0cc5_58701.png "1.png")   
实现了一个简单的编辑界面，使用了marked.js

# 总结
markdown编辑和预览是核心功能。后面的通过微信发送图片，然后自动补充到对应的topic文章中，也是要使用同样的图片处理策略。路漫漫其修远兮~。
# 下一步目标（继续当前目标）
- 主题编辑页面（markdown编辑）
