---
layout:     post
title:      "gitwriter项目4"
subtitle:   " \"gitee授权\""
date:       2017-12-13 23:59:00
author:     "huangyang"
header-img: "img/post-bg-2015.jpg"
tags:
    - gitwriter
---
# 当前目标  
- 授权管理页
- gitee授权
# 设计思路
需要支持Gitee（码云）和Wechat（微信）两个平台的授权。其中码云是必须的，因为“主题”其实就是码云所提供的Pages服务项目里面的一篇post（Pages服务基于jekyll框架提供了静态网站服务，一般用来建立个人的博客，使用markdown方式撰写博客文章）。因此需要gitee授权才能通过本应用对git仓库进行操作。微信授权面向“同事同玩”的公众号。如果希望通过手机微信来发送照片或文字类型的内容提交到一篇主题时，需要进行微信授权（码云授权是必不可少的）。如果不需要微信的方式，应用本身也提供了通过网页（目前仅规划了手机网页）的方式直接提交内容。  
本着尽快实现整理流程的思路，一切页面从简，因此授权管理页计划就放两个授权链接，下面放一个iframe，第三方的授权页面加载到iframe里。授权成功后，将得到的accesstoken与当前用户进行绑定，保存到库中。然后跳转会主页面。
# 进展
OAuth授权的流程都是一样的，具体的不同平台的api略有不同。服务端的实现，我参考了[基于Spring的Github第三方登录--通用化的第三方登陆实现](https://www.tianmaying.com/tutorial/OAuth-login-impl)，码云和github的接口几乎一摸一样，另外作者对公共流程进行了抽象，要扩展到其他平台的授权实现也比较方便。 码云的授权及OpenAPI文档在[这里](https://gitee.com/api/v5/oauth_doc)，说的清除明白。授权提供了模拟调用，openapi提供了在线测试。赞。  

在实现授权功能的时候，我遇到了两个坑。   
1、我计划将第三方授权页面放到当前页面嵌入的iframe中。没想到码云的授权页加载后会自动跳转，并且跳转的target应该是_blank，结果等于直接打开了另外一个新页面，并且全屏显示，使得前端页面“失去了控制”（这个描述或许不太准确，总之浏览器加载了一个第三方页面，我的页面已经成为历史，自然后无法通过vue-router来跳转回去），结果授权成功后，无法回到主页。最后通过在iframe中增加`security="restricted" sandbox="allow-same-origin allow-forms allow-scripts"`解决。  

2、解决了1里面的问题，我的页面保留下来了，但是我的项目是前后端分离的。后端springboot仅提供rest服务，授权的一系列动作都是在后端做的，做完后，没有办法将授权成功的消息返回到前端。这里用了一个笨办法，就是引入了websocket。唉，通过websocket来通知前端。按理来说用websocket干这点小事真有点杀鸡用牛刀了，但想想后面的功能，很多地方还需要后端push，如消息什么的，好吧，忍了。今天一个做前端的同事告诉我，其实授权回调页面直接设置成前端的页面，然后在前端通过ajax发起请求，来获得accesstoken就可以了。没必要那么麻烦。感觉这才是正确的思路。后续有空再改吧。 

最后秀几张过程图：  
![输入图片说明](https://gitee.com/uploads/images/2017/1215/004748_4b916499_58701.png "1.png")  
实现一个简单的发布主题页面（发布主题时后续还需要增加很多参数，当前只设定也给主题名称）  
![输入图片说明](https://gitee.com/uploads/images/2017/1215/004926_41095407_58701.png "1.png")  
好吧，这不是重点，重点是提交的主题去了该去的地方啦。开心。  
![输入图片说明](https://gitee.com/uploads/images/2017/1215/005529_ec4f6391_58701.png "1.png")
 
# 总结 
gitee授权成功后，新增文件调用也成功了。需要继续探索openapi的内容，实现修改文件。应用的目标不是实现一个git仓库文本文件提交的客户端。而是要允许用户能够很方便的提交基于主题的博客文章。文章的展现形式由gitee上的pages项目使用的模板决定。所以，文章的展现形式不同的用户不同的主题也是不一样的。应用会开放一个默认仓库，包含了一套默认主题。对于没有自己的gitee pages项目的人来说，可以直接使用默认的主题（现在的实现也是基于默认主题的）。如果说连gitee账户都没有的，那没办法了，毕竟这个东东是个小众的东西，本来就是打算给我们码农用的（也可以考虑使用我申请的默认账户来提交）。 

做到现在思路也渐渐清晰了，用户发起的主题可以是公开的或私有的，公开的主题根据热度等放到应用的“发现”页，私有的以及用户自己参与的放到“我的”页。主题的具体内容都保存在gitee仓库里，服务端的库里仅保存主题对应的地址信息和参数。另外，基于gitee pages服务建立的静态博客页面要引入评论只用使用社会化评论插件，这种方式我一直比较反感，试想去看个博客文章，想说两句评论，还得先用qq或微博登录，直接打消了我评论的欲望。因此后续有时间，计划引入一个很简单的评论系统。

目前应用的页面是基于手机UI框架做的，暂时没打算做成响应式的。原打算做到微信服务号的页面里面。但现在微信服务号个人无法申请了，先这样吧。PC上提交博客的方式喝多，也不太符合应用的初衷，暂时先不考虑了。

# 下一步目标
- 实现一个简单的“我的”页面，用于显示用户创建的和参与的主题列表（“参与的”下一步再说）
- 继续完善发起主题时的参数，如选择主题是公开的还是私有的，主题内容描述，主题logo图片等等
